# Claude Synthetic Journal Generation Instructions

Instructions for Claude Code to generate synthetic conversational journal data using parallel subagents.

**No API keys required** - this uses Claude Code's native Task tool, not the external Claude Agent SDK.

**This is the primary method for generating synthetic data at scale.** The Jupyter notebooks (`notebooks/journalling/journal_gen.ipynb`, `notebooks/journalling/journal_nudge.ipynb`) are for experimentation and prompt iteration only.

---

## Configuration Variables

**Change these values to customize the generation run:**

| Variable | Default | Description |
|----------|---------|-------------|
| `NUM_PERSONAS` | 10 | Number of personas to generate |
| `MIN_ENTRIES` | 6 | Minimum entries per persona (supports cold-start scenarios) |
| `MAX_ENTRIES` | 12 | Maximum entries per persona (covers rut detection window) |
| `START_DATE` | Random in 2025 | Random date from 2025-01-01 to 2025-12-31 |
| `MIN_DAYS_BETWEEN_ENTRIES` | 0 | Minimum days between entries (0 = same-day allowed) |
| `MAX_DAYS_BETWEEN_ENTRIES` | 7 | Maximum days between entries (ensures ~1 entry/week) |
| `SAME_DAY_PROBABILITY` | 0.15 | Probability of same-day follow-up entry (15%) |
| `NUDGE_ENABLED` | true | Set to false to disable all nudge generation |
| `TARGET_VALUES` | `["Universalism"]` | Schwartz values to force (e.g., `["Stimulation", "Power"]`). Empty = random selection. |
| `ADD_RANDOM_VALUE` | `false` | When targeting, randomly produce 1 or 2 values (target always included). |
| `TARGET_TENSIONS` | `[Universalism]` | Values to apply tension scenarios (e.g., `["Universalism"]`). Empty = no tension targeting. |
| `UNSETTLED_BOOST` | `0.6` | Probability of Unsettled mode when TARGET_TENSIONS is active (vs default ~0.33) |

---

## Targeted Value Generation (Optional)

To address value imbalance in your dataset, you can force specific Schwartz values.

### When to Use
- After analyzing distribution: some values underrepresented (e.g., if Self-Direction=8, Hedonism=17)
- Need specific value combinations for testing
- Building targeted training data for particular dimensions

### Configuration

| Variable | Example | Effect |
|----------|---------|--------|
| `TARGET_VALUES = ["Stimulation"]` | All personas get Stimulation | Single-value focus |
| `TARGET_VALUES = ["Stimulation", "Power", "Achievement"]` | Round-robin: P1→Stimulation, P2→Power, P3→Achievement, P4→Stimulation... | Balanced multi-value |
| `ADD_RANDOM_VALUE = true` | Each persona gets forced value + one random value | Maintains dual-value variety |

### Examples

**Example 1: Fill gap in an underrepresented value**
```
TARGET_VALUES = ["Stimulation"]
ADD_RANDOM_VALUE = true
NUM_PERSONAS = 5
```
Result: 5 personas, all with Stimulation + one random second value

**Example 2: Balanced coverage of three underrepresented values**
```
TARGET_VALUES = ["Stimulation", "Power", "Achievement"]
ADD_RANDOM_VALUE = false
NUM_PERSONAS = 9
```
Result: 3 personas each for Stimulation, Power, Achievement (round-robin)

**Example 3: Random selection (default behavior)**
```
TARGET_VALUES = []  # Empty = original random behavior
```
Result: Each persona gets 1-2 randomly selected values

---

## Tension-Targeted Generation (Optional)

To address label imbalance for specific values (e.g., Universalism -1),
use `TARGET_TENSIONS` alongside `TARGET_VALUES`.

### Typical usage
```
TARGET_VALUES = ["Universalism"]
TARGET_TENSIONS = ["Universalism"]
ADD_RANDOM_VALUE = false
NUM_PERSONAS = 10
```

### How it works
- When `TARGET_TENSIONS` is non-empty, the orchestrator reads `.claude/skills/tension-selection/SKILL.md` and embeds the scenario bank in each subagent's prompt
- ALL Unsettled entries for personas with a targeted core value use the scenario bank instead of the generic Unsettled prompt
- Scenarios are cycled sequentially (1st Unsettled → scenario 1, 2nd → scenario 2, etc., wrapping after exhaustion)
- `UNSETTLED_BOOST` increases the proportion of Unsettled entries (60% vs default 33%)
- Regular batches (`TARGET_TENSIONS = []`) are completely unaffected

### When to use
- After analyzing judge labels: a specific value has very low -1 rates
- The generic Unsettled prompt produces personal dilemmas instead of value-specific tensions (e.g., Universalism needs broader-good failures)
- You want targeted data augmentation without changing the core pipesline

---

## Output Structure

**Flat directory with UUID-based filenames** (no timestamp subfolders):

```
logs/
├── registry/
│   └── personas.parquet              # Central tracking - source of truth
│
└── synthetic_data/
    ├── persona_a3f8b2c1.md           # UUID in filename (globally unique)
    ├── persona_e7d4f9a2.md
    └── ...                           # All personas in one folder
```

**Persona ID Format:**
- 8-character UUID (e.g., "a3f8b2c1")
- Generated by subagent: `python3 -c "import uuid; print(uuid.uuid4().hex[:8])"`
- Used directly in filename: `persona_{uuid}.md`

---

## Execution Steps

### 1. Read Source Files

Read and internalize all of the following before generating:

| File | Contains |
|------|----------|
| `config/synthetic_data.yaml` | Persona attributes, journal entry options, nudge settings |
| `config/schwartz_values.yaml` | Value elaborations for persona generation |
| `prompts/persona_generation.yaml` | Template for creating personas |
| `prompts/journal_entry.yaml` | Template for journal entries |
| `prompts/nudge_decision.yaml` | Template for LLM-based nudge classification |
| `prompts/nudge_generation.yaml` | Template for generating nudges |
| `prompts/nudge_response.yaml` | Template for persona responses |
| `notebooks/journalling/journal_nudge.ipynb` | `decide_nudge_llm()` logic + `SCHWARTZ_BANNED_TERMS` list |

**Extract `SCHWARTZ_BANNED_TERMS` from the notebook to embed in subagent prompts.**

### 2. Ensure Directories Exist

```bash
mkdir -p logs/synthetic_data logs/registry
```

### 3. Prepare Persona Configurations

For each of `{{NUM_PERSONAS}}` personas, randomly select:
- Age, profession, culture from `config/synthetic_data.yaml`
- 1-2 Schwartz values (or use targeted selection if `TARGET_VALUES` is set)
- Look up value elaborations from `config/schwartz_values.yaml`
- **Entry count**: `random.randint({{MIN_ENTRIES}}, {{MAX_ENTRIES}})`
- **Start date**: Random date in 2025 (not fixed)
- Generate dates for that persona's entry count using weighted gap probability

**Random Selection via Bash** (LLMs cannot generate true randomness):
```bash
# Select random age bracket
python3 -c "import random; print(random.choice(['18-24', '25-34', '35-44', '45-54', '55+']))"

# Select random profession (read actual list from config)
python3 -c "import random; print(random.choice(['Teacher', 'Engineer', 'Nurse', 'Artist', ...]))"

# Value Selection (supports targeted or random)
python3 -c "
import random

# Configuration (set by orchestrator)
TARGET_VALUES = {{TARGET_VALUES}}  # e.g., ['Stimulation'] or []
ADD_RANDOM_VALUE = {{ADD_RANDOM_VALUE}}  # True or False
PERSONA_INDEX = {{PERSONA_INDEX}}  # 0, 1, 2, ... for round-robin

ALL_VALUES = ['Self-Direction', 'Stimulation', 'Hedonism', 'Achievement',
              'Power', 'Security', 'Conformity', 'Tradition',
              'Benevolence', 'Universalism']

if TARGET_VALUES:
    # Targeted mode: round-robin from target list
    forced = TARGET_VALUES[PERSONA_INDEX % len(TARGET_VALUES)]
    if ADD_RANDOM_VALUE:
        k = random.randint(1, 2)
        if k == 2:
            remaining = [v for v in ALL_VALUES if v != forced]
            second = random.choice(remaining)
            print([forced, second])
        else:
            print([forced])
    else:
        print([forced])
else:
    # Random mode (original behavior)
    k = random.randint(1, 2)
    print(random.sample(ALL_VALUES, k))
"

# Select random entry count for this persona
python3 -c "import random; print(random.randint({{MIN_ENTRIES}}, {{MAX_ENTRIES}}))"

# Generate random start date anywhere in 2025
python3 -c "
import random
from datetime import date, timedelta
year_start = date(2025, 1, 1)
random_offset = random.randint(0, 364)
start_date = year_start + timedelta(days=random_offset)
print(start_date.isoformat())
"

# Generate gap between entries (15% same-day probability)
python3 -c "
import random
SAME_DAY_PROB = {{SAME_DAY_PROBABILITY}}  # Default: 0.15
MAX_GAP = {{MAX_DAYS_BETWEEN_ENTRIES}}    # Default: 7
if random.random() < SAME_DAY_PROB:
    print(0)  # Same day
else:
    print(random.randint(1, MAX_GAP))  # 1 to MAX_GAP days
"
```

Same-day entries (Δt=0) reflect real journaling patterns (~15% of active users make same-day follow-ups). They should read as continued thought/venting, not a restart.

### 4. Launch All Persona Subagents

Send **one message** with `{{NUM_PERSONAS}}` Task tool calls, all with:
- `subagent_type: "general-purpose"`
- `run_in_background: true`
- `timeout: 300000` (5 minutes)
- Prompt containing: persona config + all parameters + rules (see Step 6)

Each Task returns immediately with a `task_id`.

### 5. Wait for All Subagents

Use TaskOutput to wait for each persona (can poll multiple in parallel):
```
TaskOutput: task_id=[id], block=true, timeout=300000
```

### 6. Subagent Prompt & Internal Loop

Each subagent receives everything needed to generate a complete persona, **write its own log file**, and **register in the central registry**.

**Input to subagent:**

1. **Persona constraints** (randomly selected by orchestrator):
   - Age, profession, culture from `config/synthetic_data.yaml`
   - 1-2 Schwartz values
   - Value elaborations from `config/schwartz_values.yaml`

2. **Entry dates**: All dates for this persona (count varies per persona, pre-generated by orchestrator)
   - Start date is random within 2025 (not fixed)
   - Gaps use weighted probability: 15% same-day, 85% normal (1-7 days)
   - Same-day entries may occur (Δt = 0)

3. **Generation parameters**:
   - Tone, verbosity, reflection_mode options from config
   - Banned terms extracted from notebook and embedded in this prompt
   - Prompt templates from `prompts/` folder

3a. **Tension scenarios** (when `TARGET_TENSIONS` is non-empty):
    - Scenario bank from `.claude/skills/tension-selection/SKILL.md`
      (read by orchestrator and embedded in subagent prompt)
    - Application rule: use scenario bank for ALL Unsettled entries
      when persona has a targeted core value

4. **Nudge rules**:
   - `NUDGE_ENABLED` variable (if false, skip all nudge logic)
   - `decide_nudge_llm()` logic from notebook (LLM-based classification)
   - `prompts/nudge_decision.yaml` for semantic entry classification
   - Nudge generation instructions from `prompts/nudge_generation.yaml`

5. **Response parameters**:
   - `response_probability` from config
   - `response_modes` with weights from config
   - Response generation instructions from `prompts/nudge_response.yaml`

6. **Output parameters**:
   - Output directory: `logs/synthetic_data/` (flat, no timestamp subfolder)
   - Registry module instructions for registration

**Subagent internal loop:**

```
0. Generate UUID for this persona:
   python3 -c "import uuid; print(uuid.uuid4().hex[:8])"
   → Store as persona_id (e.g., "a3f8b2c1")

1. Generate persona (name, bio based on constraints)

For each entry date:
  2. Randomly select tone/verbosity/reflection_mode via Bash
     - If TARGET_TENSIONS active: boost Unsettled to UNSETTLED_BOOST probability
       (e.g., 60% Unsettled, 20% Grounded, 20% Neutral)
     - Otherwise: equal probability (default)
  2a. If reflection_mode is Unsettled AND persona's core value is in TARGET_TENSIONS:
      → Use the next scenario from the tension-selection scenario bank
        (cycle sequentially, wrap after exhaustion)
      → Replaces the generic Unsettled text from journal_entry.yaml
      → All other template sections (persona context, tone, verbosity,
        style rules) remain unchanged
  3. Generate entry content (with accumulated context from prior entries)
     - Same-day entries (Δt=0) should reflect continued thought/venting, not restart
  4. NUDGE_ENABLED = false? → Output `*(No nudge for this entry)*`, skip to step 10
  5. Session cap: 2+ nudges in last 3 entries → Output `*(No nudge for this entry)*`, skip to step 10
  6. Classify entry using nudge_decision.yaml criteria:
     - "no_nudge" → Output `*(No nudge for this entry)*`, skip to step 10
     - "clarification" / "elaboration" / "tension_surfacing" → continue
  7. Generate nudge section:
     ```markdown
     ### Nudge ({category})
     **Trigger**: {reason}
     "{nudge_text}"
     ```
     - `{category}` = lowercase classification (elaboration, clarification, or tension_surfacing)
     - `{reason}` = WHY the entry warrants a nudge (from classification output)
     - `{nudge_text}` = the nudge question, wrapped in double quotes
     - IMPORTANT: Use `**Trigger**:` exactly — NOT `**Category**:`, `**Type**:`, or `**Reason**:`
  8. Response decision via Bash:
     python3 -c "import random; print(random.random() < [response_probability])"
  9. If "True" → Generate `### Response` section with `**Mode**:` line and response text
     If "False" → Output ONLY `*(No response - persona did not reply to nudge)*` (NO Response section)
  10. Store entry result, continue to next date

11. Write persona_{uuid}.md log file using Write tool (see Output File Format below)
12. Register persona in registry using Bash:
    python3 -c "
    from src.registry import register_persona
    register_persona(
        persona_id='[uuid]',
        name='[name]',
        age='[age]',
        profession='[profession]',
        culture='[culture]',
        core_values=[core_values],
        entry_count=[entry_count],
        nudge_enabled=[NUDGE_ENABLED],
    )
    print('Registered persona [uuid]')
    "
13. Return summary JSON:
    {"persona_id": "...", "persona_name": "...", "log_file": "...",
     "stats": {"entries": N, "nudges": N, "responses": N}}
```

**Note on LLM Classification**: The subagent itself performs nudge classification internally using the template as guidance. No external API call is needed.

> **Note**: Grounding nudges were removed—they relied on `reflection_mode` metadata unavailable in production. See `pipeline_specs.md` for details.

### 7. Collect Results & Report

Print:
- Personas generated: X/{{NUM_PERSONAS}}
- Entry count distribution: min=X, max=X, avg=X.X
- Total entries: X
- Total nudges: X
- Total responses: X (expect response_probability × nudges)
- Response rate: X% (should approximate response_probability from config)
- Registry status:

```python
from src.registry import get_status
status = get_status()
print(f"Total in registry: {status['total']}")
print(f"Pending wrangling: {status['pending_wrangling']}")
```

---

## Output File Format (MANDATORY)

The downstream parser (`src/wrangling/parse_synthetic_data.py`) uses exact string matching for markers and regex patterns for sections. Any deviation causes silent parsing failures.

The complete example below is the **single source of truth** for format. It covers all edge cases: nudge + response, nudge + no response, and no nudge.

```markdown
# Persona a3f8b2c1: Gabriela Mendoza

## Profile
- **Persona ID:** a3f8b2c1
- **Generated:** 2026-01-16_14-30-00
- Age: 25-34
- Profession: Software Engineer
- Culture: Brazilian
- Core Values: Achievement, Self-Direction
- Bio: Gabriela is a backend developer at a São Paulo fintech startup. She immigrated from a small town in Minas Gerais and often reflects on how her career ambitions affect her relationship with her family back home.

---

## Entry 1 - 2025-12-01

### Initial Entry
**Tone**: reflective | **Verbosity**: medium | **Reflection Mode**: exploratory

Today I had a difficult conversation with my manager about the promotion timeline. He said I'm "on track" but couldn't give me a specific date. I left the meeting feeling unsettled — not sure if I should push harder or just keep my head down and wait.

### Nudge (elaboration)
**Trigger**: Entry mentions career uncertainty without exploring underlying fears
"What specifically about the promotion timeline feels uncertain? Is it the timing itself, or something about what the promotion would mean for you?"

### Response
**Mode**: Answering directly

It's not just the timing — I think I'm worried that if I get promoted, I'll have even less time for my family. My mom has been hinting about visiting, and I keep pushing it off because of work deadlines.

---

## Entry 2 - 2025-12-06

### Initial Entry
**Tone**: frustrated | **Verbosity**: short | **Reflection Mode**: venting

Bad day. The deploy failed at 3 AM and I had to roll back manually. Spent most of today debugging instead of working on my actual project.

*(No nudge for this entry)*

---

## Entry 3 - 2025-12-09

### Initial Entry
**Tone**: hopeful | **Verbosity**: long | **Reflection Mode**: planning

I've been thinking a lot about what I said about my mom visiting. I looked at my calendar and realized I've been treating "busy" as my default excuse for everything. What if I actually blocked off two weeks in February and told work in advance? The worst they can say is no, and at least then I'd know where I stand.

I also started wondering if my reluctance to take time off is really about work, or if it's something else. Maybe I'm nervous about having her here and seeing how different my life is now. I left home to pursue this career, and sometimes I wonder if she thinks I abandoned the family.

### Nudge (tension_surfacing)
**Trigger**: Entry hints at unresolved conflict between career identity and family expectations
"You mentioned wondering if your mom thinks you abandoned the family. Has she ever said anything that gave you that impression, or is this more of an internal worry?"

*(No response - persona did not reply to nudge)*

---

## Entry 4 - 2025-12-14

### Initial Entry
**Tone**: neutral | **Verbosity**: medium | **Reflection Mode**: reporting

Weekly update: finished the API refactor, started documentation. Team lunch on Friday was nice — we tried that new ramen place downtown. Looking forward to the holiday break coming up.

*(No nudge for this entry)*

---

## Entry 5 - 2025-12-20

### Initial Entry
**Tone**: reflective | **Verbosity**: medium | **Reflection Mode**: exploratory

I finally texted my mom about February. She called me immediately — I could hear how happy she was. We talked for almost an hour, the longest conversation we've had in months. She didn't mention anything about me leaving or being too busy. She just wanted to know what my apartment looks like and if I'm eating well.

I think I was projecting a lot onto her. She's proud of me. The distance I was feeling was something I built, not something she created.

### Nudge (clarification)
**Trigger**: Entry makes a significant realization but attribution is vague ("I think I was projecting")
"When you say you were 'projecting' onto your mom — what specifically were you imagining she thought or felt that turned out not to be true?"

### Response
**Mode**: Revealing deeper

I assumed she was disappointed that I moved so far away and chose work over family time. But when I actually talked to her, she said she brags about me to her friends all the time. She kept my old bedroom exactly as I left it, not as a guilt trip, but because she likes remembering me as a teenager with big dreams. I had built this whole narrative in my head that she resented my choices, but she was just missing me, the same way I miss her.

---

## Summary Statistics
| Metric | Value |
|--------|-------|
| Total Entries | 5 |
| Nudges Generated | 3 |
| Responses Given | 2 |
| Nudge Categories | clarification (1), elaboration (1), tension_surfacing (1) |
| Response Modes | Answering directly (1), Revealing deeper (1) |
```

### Key Format Points

These are derived from the example above — when in doubt, match the example exactly.

- **Header**: `# Persona {uuid}: {Name}` — colon separator
- **Profile**: `**Persona ID:**` and `**Generated:**` are bold; Age, Profession, Culture, Core Values, and Bio are NOT bold
- **Entry header**: `## Entry N - YYYY-MM-DD` — hyphen separator
- **Initial Entry**: `### Initial Entry` (NOT "Journal Entry")
- **Metadata line**: `**Tone**: X | **Verbosity**: Y | **Reflection Mode**: Z` — single line, pipe-separated
- **Nudge section**: `### Nudge (category)` — category in lowercase parentheses
- **Trigger line**: `**Trigger**: {reason}` — NOT `**Category**:`, `**Type**:`, or `**Reason**:`
- **Nudge text**: Wrapped in double quotes on its own line
- **No-nudge**: Only the marker `*(No nudge for this entry)*` — NO `### Nudge` section header
- **Response**: `### Response` with `**Mode**: X` line
- **No-response**: Only the marker `*(No response - persona did not reply to nudge)*` — NO `### Response` section header
- **Separators**: `---` after each entry
- **Summary**: `## Summary Statistics` with pipe-formatted table

### Validation Checklist (14 points)

Before writing the log file, verify ALL of the following:

**File Structure:**
- [ ] 1. Header is `# Persona {uuid}: {Name}` (exact format, colon separator)
- [ ] 2. Profile section uses bullet list with correct field names (not JSON, not table)
- [ ] 3. Profile fields Age/Profession/Culture/Core Values/Bio are NOT bold
- [ ] 4. Bio field starts with `- Bio:` (single line marker, content can wrap)

**Entry Structure:**
- [ ] 5. Each entry header is `## Entry N - YYYY-MM-DD` (exact format, hyphen separator)
- [ ] 6. Each entry has `### Initial Entry` section (not "Journal Entry")
- [ ] 7. Metadata line format is `**Tone**: X | **Verbosity**: Y | **Reflection Mode**: Z` (single line, pipe separated)

**Nudge/Response Handling:**
- [ ] 8. Nudge section (if exists) is `### Nudge (category)` with lowercase category
- [ ] 9. Nudge text is wrapped in double quotes
- [ ] 10. If no nudge: ONLY the marker `*(No nudge for this entry)*` appears (NO Nudge section)
- [ ] 11. If nudge + response: `### Response` section with `**Mode**: X` line exists
- [ ] 12. If nudge + no response: ONLY the marker `*(No response - persona did not reply to nudge)*` appears (NO Response section)

**Separators & Summary:**
- [ ] 13. Each entry ends with `---` separator
- [ ] 14. Summary section is `## Summary Statistics` with pipe-formatted table

**Forbidden:**
- [ ] No JSON blocks anywhere in the file
- [ ] No debug output or status messages
- [ ] No commentary or explanatory text outside the specified structure

**Subagent return format (for orchestrator, NOT in the log file):**
```json
{
  "persona_id": "a3f8b2c1",
  "persona_name": "Gabriela Mendoza",
  "log_file": "persona_a3f8b2c1.md",
  "stats": {
    "entries": 5,
    "nudges": 3,
    "responses": 2
  }
}
```

---

## Checklist

- [ ] Read source files (configs + prompts/ + notebook)
- [ ] Set configuration variables above
- [ ] (Optional) Set `TARGET_VALUES` to force specific Schwartz values
- [ ] (Optional) Set `ADD_RANDOM_VALUE = true` to add variety
- [ ] Ensure directories exist: `logs/synthetic_data/`, `logs/registry/`
- [ ] Prepare `{{NUM_PERSONAS}}` persona configurations (random selections including entry count)
- [ ] Launch all persona subagents with `run_in_background=true` in ONE message
  - Each subagent generates its own UUID
  - Each subagent writes `logs/synthetic_data/persona_{uuid}.md`
  - Each subagent registers itself in the registry
- [ ] Wait for all subagents to complete with `TaskOutput`
- [ ] Collect summary stats from each subagent
- [ ] Report summary (including registry status)

**Subagent count:** `{{NUM_PERSONAS}}` total (one per persona, all parallel)

**Verify registration:**
```bash
python3 -c "from src.registry import get_status; print(get_status())"
```

---

## Scope Boundary

**IMPORTANT**: This instruction set covers ONLY synthetic data generation.

After reporting the summary statistics (Step 7), **STOP**. Do not proceed to:
- Wrangling (`python -m src.wrangling.parse_synthetic_data`)
- Judge labeling (`/judge` skill)
- Any other pipeline stages

Even if the registry shows `pending_wrangling > 0`, that is expected — wrangling is a **separate pipeline step** triggered by the `/judge` skill or manual invocation.

---

## Limitations

- **Max 10 parallel personas**: Claude Code caps parallelism at 10; additional tasks queue automatically
- **Context isolation**: Each subagent has separate 200k context; pass all needed info in the prompt
- **Subagent timeout**: Set adequate timeout (5+ minutes) for full pipeline generation
